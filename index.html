<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>📘 جدول المحاضرات</title>
<link rel="icon" href="icons/favicon.png">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<!-- Firebase SDK للإشعارات -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
<style>
:root{
  --accent1:#60a5fa; --accent2:#7c3aed;
  --bg-grad: linear-gradient(90deg,var(--accent1),var(--accent2));
  --card:#ffffff; --text:#071127; --muted:#475569;
  --cell-border: rgba(2,6,23,0.06);
  --th-bg: rgba(0,0,0,0.03);
  transition: all 0.3s ease; /* انتقال سلس للثيم */
}
[data-theme="dark"]{
  --card:#071127; --text:#e6eef8; --muted:#9ca3af; --cell-border: rgba(255,255,255,0.06);
  --bg-grad: linear-gradient(90deg,#0f172a,#0b1220);
  --th-bg: rgba(255,255,255,0.06);
}
*{box-sizing:border-box}
body{margin:0;font-family:'Cairo',sans-serif;background:var(--bg-grad);color:var(--text);min-height:100vh}
.container{max-width:1200px;margin:0 auto;padding:18px}
.header-row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px;color:white}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:52px;height:52px;border-radius:10px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;font-size:28px}
.title{font-size:20px;font-weight:800}
.controls{display:flex;gap:8px;align-items:center}
.btn{background:white;color:#3730a3;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700;transition: all 0.3s ease;} /* إضافة transition للزر */
.btn:hover{background:var(--accent1);color:white;} /* hover مع accent1 */
.small-btn{background:transparent;border:1px solid rgba(255,255,255,0.18);color:white;padding:6px 10px;border-radius:8px;cursor:pointer;transition: all 0.3s ease;}
.small-btn:hover{background:rgba(255,255,255,0.12);}
.info-badge{background:rgba(255,255,255,0.16);padding:6px 10px;border-radius:8px;font-size:13px}
.nav{display:flex;gap:8px;margin:12px 0}
.tab-btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;background:rgba(255,255,255,0.12);color:white;font-weight:700}
.tab-btn.active{background:white;color:#3730a3}
.card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 8px 30px rgba(2,6,23,0.12);color:var(--text)}
.table-wrap{overflow:auto}
.table{width:100%;border-collapse:collapse;background:var(--card);border-radius:8px;overflow:hidden}
.table th, .table td{border:1px solid var(--cell-border);padding:10px;text-align:center;font-size:14px}
.table th{background:var(--th-bg);font-weight:800}
.slot{padding:6px;border-radius:6px}
.slot .meta{font-size:12px;color:var(--muted);margin-top:6px}
.empty{opacity:0.45}
.current{outline:3px solid rgba(124,58,237,0.18);box-shadow:0 6px 18px rgba(124,58,237,0.08)}
.legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.legend-item{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.06);font-size:13px}
.footer{padding:12px;text-align:center;color:rgba(255,255,255,0.9);opacity:0.9;margin-top:12px}
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;padding:16px;z-index:9999}
.modal{width:100%;max-width:900px;background:var(--card);border-radius:12px;padding:16px;color:var(--text);max-height:90vh;overflow:auto}
.input, textarea, select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(2,6,23,0.06);margin-top:6px}
.row{display:flex;gap:8px}
.col{flex:1}
.kv{font-size:13px;color:var(--muted)}
.top-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between}
.days-tabs{display:flex;gap:6px;flex-wrap:wrap}
.day-tab{padding:6px 10px;border-radius:8px;border:none;cursor:pointer;background:rgba(15,23,42,0.03)}
.day-tab.active{background:var(--accent2);color:white}
@media (max-width:900px){
  .header-row{flex-direction:column;align-items:flex-start}
  .row{flex-direction:column}
  .table th, .table td{font-size:12px;padding:8px}
}
.notice-small{font-size:13px;color:rgba(255,255,255,0.9);opacity:0.95;margin-top:6px}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}

/* إضافات للعداد المتقدم في الهيدر */
.live-countdown {
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}
.upcoming-soon {
  background: rgba(255, 215, 0, 0.2) !important;
  border-color: #ffd700 !important;
  animation: shake 0.5s;
}

/* تنسيق الزر الجديد للإشعارات (مطابق للتصميم) */
#subscribeBtn {
  background: white;
  color: #3730a3;
  padding: 8px 12px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: 700;
  font-family: 'Cairo', sans-serif;
  transition: all 0.3s ease;
  margin: 0 8px; /* gap مع الأزرار الأخرى */
}
#subscribeBtn:hover {
  background: var(--accent1); /* أزرق فاتح من الـ accent */
  color: white;
  box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3); /* ظل خفيف */
}
#status {
  background: rgba(255,255,255,0.16); /* مطابق لـ info-badge */
  padding: 6px 10px;
  border-radius: 8px;
  font-size: 13px;
  color: white;
  opacity: 0.9;
  margin: 0;
  display: inline-block;
}
[data-theme="dark"] #status {
  background: rgba(255,255,255,0.1); /* تكيف مع الدارك مود */
}
</style>
</head>
<body>
<div class="container">
  <div class="header-row">
    <div class="brand">
      <div class="logo">📘</div>
      <div>
        <div class="title">📘 جدول المحاضرات</div>
        <div class="notice-small">يتم تحديث الجدول يومياً</div>
      </div>
    </div>
    <div class="controls">
      <div id="liveNotice" class="info-badge">حساب...</div>
      <!-- الزر الجديد: مطابق للتصميم (داخل controls مع gap) -->
      <button id="subscribeBtn" onclick="requestPermission()">فعل الإشعارات 🔔</button>
      <span id="status"></span> <!-- status هنا للعرض -->
      <div style="display:flex;gap:8px;align-items:center">
        <button id="exportBtn" class="small-btn" title="تصدير JSON">تصدير</button>
        <button id="importBtn" class="small-btn" title="استيراد JSON">استيراد</button>
        <button id="printBtn" class="small-btn" title="تحميل PDF">تحميل PDF</button>
        <button id="adminBtn" class="btn" title="لوحة الإدارة">لوحة الإدارة</button>
        <button id="themeToggle" class="small-btn" title="تبديل الوضع">الوضع</button>
      </div>
    </div>
  </div>

  <nav class="nav">
    <button class="tab-btn active" data-tab="weekly">الجدول الأسبوعي</button>
    <button class="tab-btn" data-tab="day">اليوم</button>
    <button class="tab-btn" data-tab="instructors">الدكاترة</button>
  </nav>

  <main>
    <!-- Weekly Tab -->
    <section id="tab-weekly" class="card table-wrap">
      <h3>الجدول الأسبوعي</h3>
      <div class="top-actions" style="margin-bottom:8px">
        <div class="kv">ساعات: 8:00 ص → 10:00 م</div>
        <div id="legend" class="legend"></div>
      </div>
      <div id="tableContainer"></div>
    </section>

    <!-- Day Tab -->
    <section id="tab-day" class="card" style="display:none;margin-top:12px">
      <h3>محاضرات حسب اليوم</h3>
      <div class="days-tabs" id="daysTabs"></div>
      <div id="dayContainer" style="margin-top:12px"></div>
    </section>

    <!-- Instructors Tab -->
    <section id="tab-instructors" class="card" style="display:none;margin-top:12px">
      <h3>الدكاترة</h3>
      <div id="instructorList" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px"></div>
    </section>

    <section class="card" style="margin-top:12px">
      <h4>تصميم وبرمجة: Khaled El-Reweni 💻</h4>
    </section>
  </main>

  <footer class="footer">© جدول المحاضرات</footer>
</div>

<div id="modalRoot" style="display:none"></div>

<script>
/* Firebase Config (غير بالقيم الحقيقية من Firebase console!) – مؤقتًا مع try-catch */
let messaging; // global للإشعارات
const SERVER_KEY = 'YOUR_ACTUAL_SERVER_KEY_HERE'; // غيّر ده بـ Server Key الحقيقي من Firebase Console > Project Settings > Cloud Messaging > Server key
try {
  const firebaseConfig = {
    apiKey: "AIzaSyCNxv8rljPPLks03giwrjrIv018MdZkSoM",
    authDomain: "jadwal-app-12d0c.firebaseapp.com",
    projectId: "jadwal-app-12d0c",
    storageBucket: "jadwal-app-12d0c.firebasestorage.app",
    messagingSenderId: "599880482581",
    appId: "1:599880482581:web:21d65c1aacfa68b83d331c",
  measurementId: "G-LM8SPG04XK"
  };
  firebase.initializeApp(firebaseConfig);
  messaging = firebase.messaging();
  console.log('Firebase initialized successfully');

  // Foreground messages (إشعارات داخل الصفحة عندما تكون مفتوحة)
  messaging.onMessage((payload) => {
    console.log('Foreground message: ', payload);
    // عرض alert أو toast في الصفحة (يمكن تخصيصه لاحقًا)
    alert(payload.notification?.body || 'تحديث جديد في الجدول!');
  });

} catch (error) {
  console.error('Firebase initialization failed (config not set yet):', error);
  messaging = null; // لتجنب أخطاء لاحقة
}

// تسجيل service worker للإشعارات (مع try-catch للأمان)
if ('serviceWorker' in navigator && messaging) {
  navigator.serviceWorker.register('/firebase-messaging-sw.js')
    .then((registration) => { 
      console.log('SW registered for notifications:', registration); 
    })
    .catch((error) => { 
      console.error('SW registration failed:', error); 
    });
}

/* Config */
const ENCODED_PASSWORD = 'S2hhbGVkMjExMCU='; // 'Khaled2110%'
const ADMIN_PASSWORD = atob(ENCODED_PASSWORD); // decode عند التشغيل
const STORAGE_KEY_THEME = 'jadwal_theme';
const STORAGE_KEY_DATA = 'jadwal_data'; // مفتاح لحفظ البيانات محليًا
const DAYS = ['السبت','الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس','الجمعة'];
const HOURS = Array.from({length:15},(_,i)=>8+i); // 8 ص إلى 10 م (15 ساعة)

/* بيانات افتراضية ثابتة (hardcode) – عدلها هنا وارفع على GitHub عشان تظهر للكل */
let DATA = {
  lectures: [
  {
    "id": "idmgmpsika3qsxarr",
    "day": "السبت",
    "startHour": 10,
    "startMin": 0,
    "endHour": 14,
    "endMin": 0,
    "title": "أساسيات تمريض نظري",
    "instructorId": "idmgmppo05hohhc2a",
    "instructorName": null,
    "location": ".",
    "notes": "",
    "link": ""
      },
  {
    "id": "idmgmpsz94t0e99l6",
    "day": "الأحد",
    "startHour": 19,
    "startMin": 0,
    "endHour": 20,
    "endMin": 0,
    "title": "علم الأدوية",
    "instructorId": "idmgmppuxcbxi1den",
    "instructorName": null,
    "location": ".",
    "notes": "",
    "link": ""
  },
  {
    "id": "idmgmptfeanvioois",
    "day": "السبت",
    "startHour": 20,
    "startMin": 0,
    "endHour": 22,
    "endMin": 0,
    "title": "قضايا مجتمعية",
    "instructorId": "idmgmpq3h21xx212z",
    "instructorName": null,
    "location": ".",
    "notes": "",
    "link": ""
  },
  {
    "id": "idmgmpug13730m16c",
    "day": "الاثنين",
    "startHour": 11,
    "startMin": 0,
    "endHour": 13,
    "endMin": 0,
    "title": "تكنولوجيا المعلومات",
    "instructorId": "idmgmpqa5qqyf0nzw",
    "instructorName": null,
    "location": ".",
    "notes": "",
    "link": ""
  },
  {
    "id": "idmgmpv1ngk5va8mo",
    "day": "الأحد",
    "startHour": 11,
    "startMin": 0,
    "endHour": 13,
    "endMin": 0,
    "title": "مهارات التواصل",
    "instructorId": "idmgmpqgwlzfuzmfp",
    "instructorName": null,
    "location": ".",
    "notes": "",
    "link": ""
  },
  {
    "id": "idmgmpvuvji5i63d0",
    "day": "الاثنين",
    "startHour": 9,
    "startMin": 0,
    "endHour": 11,
    "endMin": 0,
    "title": "أخلاقيات المهنة",
    "instructorId": "idmgmpqp7cjku2mud",
    "instructorName": null,
    "location": ".",
    "notes": "",
    "link": ""
  },
  {
    "id": "idmgmpwc4otaxwt8k",
    "day": "الثلاثاء",
    "startHour": 9,
    "startMin": 0,
    "endHour": 11,
    "endMin": 0,
    "title": "التغذية",
    "instructorId": "idmgmpr2vt4aplmm6",
    "instructorName": null,
    "location": ".",
    "notes": "",
    "link": ""
  },
  {
    "id": "idmgmpwxfmvhiz0pz",
    "day": "الثلاثاء",
    "startHour": 11,
    "startMin": 0,
    "endHour": 13,
    "endMin": 0,
    "title": "التثقيف الصحي",
    "instructorId": "idmgmpreo1qm5kzsv",
    "instructorName": null,
    "location": ".",
    "notes": "",
    "link": ""
  },
  {
    "id": "idmgmq4y5wueq1ygn",
    "day": "الأربعاء",
    "startHour": 11,
    "startMin": 0,
    "endHour": 17,
    "endMin": 0,
    "title": "أساسيات التمريض (عملي)",
    "instructorId": "idmgmprrsmw1qub9g",
    "instructorName": null,
    "location": ".",
    "notes": "",
    "link": ""
  },
  {
    "id": "idmgmq5mhj66lo0na",
    "day": "الخميس",
    "startHour": 8,
    "startMin": 0,
    "endHour": 14,
    "endMin": 0,
    "title": "أساسيات التمريض (عملي)",
    "instructorId": "idmgmprrsmw1qub9g",
    "instructorName": null,
    "location": ".",
    "notes": "",
    "link": ""
  },
  {
    "id": "idmgmq7f7285cuk9i",
    "day": "الخميس",
    "startHour": 18,
    "startMin": 0,
    "endHour": 19,
    "endMin": 0,
    "title": "لغة إنجليزية 2",
    "instructorId": "idmgmq6jaotttg27g",
    "instructorName": null,
    "location": ".",
    "notes": "",
    "link": ""
  }
],
  instructors: [
  {
    "id": "idmgmppo05hohhc2a",
    "name": "د.دعاء أمين \\ د.أسماء شحاته",
    "title": "",
    "subjects": [
      "أساسيات تمريض نظري"
    ],
    "bio": ""
  },
  {
    "id": "idmgmppuxcbxi1den",
    "name": "د.ياسمين عطية",
    "title": "",
    "subjects": [
      "علم الأدوية"
    ],
    "bio": ""
  },
  {
    "id": "idmgmpq3h21xx212z",
    "name": "د.بسمة طاهر",
    "title": "",
    "subjects": [
      "قضايا مجتمعية"
    ],
    "bio": ""
  },
  {
    "id": "idmgmpqa5qqyf0nzw",
    "name": "د.أسماء محى الدين \\ د.سعاد عرفة",
    "title": "",
    "subjects": [
      "تكنولوجيا المعلومات"
    ],
    "bio": ""
  },
  {
    "id": "idmgmpqgwlzfuzmfp",
    "name": "د.مروة فؤاد \\ د.إيمان السقا",
    "title": "",
    "subjects": [
      "مهارات التواصل"
    ],
    "bio": ""
  },
  {
    "id": "idmgmpqp7cjku2mud",
    "name": "د.أمل جمال",
    "title": "",
    "subjects": [
      "أخلاقيات المهنة"
    ],
    "bio": ""
  },
  {
    "id": "idmgmpr2vt4aplmm6",
    "name": "د.جيهان الزلباني",
    "title": "",
    "subjects": [
      "التغذية"
    ],
    "bio": ""
  },
  {
    "id": "idmgmpreo1qm5kzsv",
    "name": "د.سالي فايد \\ د.إيمان عنان",
    "title": "",
    "subjects": [
      "التثقيف الصحي"
    ],
    "bio": ""
  },
  {
    "id": "idmgmprrsmw1qub9g",
    "name": "م \\ اسماء البنان – م\\ اسراء السعيد – م\\ مريم ربيع",
    "title": "",
    "subjects": [
      "أساسيات التمريض (عملي)"
    ],
    "bio": ""
  },
  {
    "id": "idmgmq6jaotttg27g",
    "name": "د.ابتسام الشقروفي",
    "title": "",
    "subjects": [
      "لغة انجليزية"
    ],
    "bio": ""
  }
],
  changes: []
};
window.isAdmin = false;

/* Time helpers */
function to12(h){ const period = h>=12 ? 'م' : 'ص'; let hh = h%12; if(hh===0) hh=12; return hh + ':00 ' + period; }
function to12WithMin(h,m){ const hour = parseInt(h,10); const period = hour>=12 ? 'م' : 'ص'; let hh = hour%12; if(hh===0) hh=12; return hh + ':' + String(m).padStart(2,'0') + ' ' + period; }

/* دالة جديدة لعرض الساعة في رأس الجدول (12 ساعة بدون :00) */
function displayHour(h) {
  const period = h >= 12 ? 'م' : 'ص';
  let hh = h % 12;
  if (hh === 0) hh = 12;
  return hh + ' ' + period;
}

/* دالة للحصول على التاريخ والوقت الحالي بتوقيت القاهرة (مصر، UTC+2) */
function getCairoTime() {
  const now = new Date();
  const cairoTime = new Intl.DateTimeFormat('en-US', {
    timeZone: 'Africa/Cairo',
    year: 'numeric',
    month: 'numeric',
    day: 'numeric',
    hour: 'numeric',
    minute: 'numeric',
    second: 'numeric',
    hour12: false
  }).formatToParts(now);
  const year = parseInt(cairoTime.find(p => p.type === 'year').value);
  const month = parseInt(cairoTime.find(p => p.type === 'month').value) - 1; // JS months 0-based
  const day = parseInt(cairoTime.find(p => p.type === 'day').value);
  const hour = parseInt(cairoTime.find(p => p.type === 'hour').value);
  const minute = parseInt(cairoTime.find(p => p.type === 'minute').value);
  const second = parseInt(cairoTime.find(p => p.type === 'second').value);
  return new Date(year, month, day, hour, minute, second);
}

/* دالة للحصول على رقم اليوم في الأسبوع بتوقيت القاهرة (السبت = 0) */
function getCairoDayIndex() {
  const cairoNow = getCairoTime();
  let jsDay = cairoNow.getDay(); // JS: Sunday=0, Saturday=6
  return (jsDay + 1) % 7; // تحويل: Saturday=0, Sunday=1, ..., Friday=6
}

/* Data helpers (حفظ/تحميل من localStorage للثبات المحلي) */
function uid(){ return 'id' + Date.now().toString(36) + Math.random().toString(36).slice(2,9); }
function saveTheme(theme){ localStorage.setItem(STORAGE_KEY_THEME, theme); }
function loadTheme(){ return localStorage.getItem(STORAGE_KEY_THEME) || 'light'; }
function saveDataToLocal() {
  try {
    localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(DATA));
  } catch (e) {
    console.error('خطأ في حفظ البيانات في localStorage:', e);
  }
}
function loadDataFromLocal() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY_DATA);
    if (saved) {
      const parsed = JSON.parse(saved);
      if (parsed.lectures && parsed.instructors) {
        DATA = parsed;
        console.log('تم تحميل البيانات من localStorage');
      }
    }
  } catch (e) {
    console.error('خطأ في تحميل البيانات:', e);
  }
}
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* Color per subject */
const colorCache={};
function genColor(title){ 
  if(!title) return {bg:'rgba(243,244,246,0.6)',solid:'#e5e7eb'}; 
  if(colorCache[title]) return colorCache[title]; 
  let h=0; 
  for(let i=0;i<title.length;i++){ h=(h<<5)-h+title.charCodeAt(i); h|=0; } 
  const r=Math.abs(h)%200+20;   const g=(Math.abs(h*13)%150)+80; 
  const b=(Math.abs(h*7)%180)+40; 
  const bg='rgba('+r+','+g+','+b+',0.18)'; 
  const solid='rgba('+r+','+g+','+b+',0.95)'; 
  colorCache[title]={bg,solid}; 
  return colorCache[title]; 
}

/* دالة الاشتراك في الإشعارات (محسنة مع error handling وتحديث token) */
async function requestPermission() {
  try {
    if (!messaging) {
      document.getElementById('status').textContent = 'Firebase غير مفعّل – لا يمكن الإشعارات.';
      document.getElementById('status').style.color = 'red';
      return;
    }
    const permission = await Notification.requestPermission();
    if (permission === 'granted') {
      const token = await messaging.getToken({ vapidKey: 'BOcsE4nI5fIDQW8hFa-43M1IGZUAl13oDNaI5MkTR8BCvy9CVoExINdp9xLg_PLaWWyL-dsJHPmAlccuS2Xt7vs' });  // VAPID key من Firebase
      if (token) {
        // اشتراك في topic
        await messaging.subscribeToTopic(token, 'jadwal-updates');
        console.log('Token generated and subscribed:', token);
        document.getElementById('status').textContent = 'تم التسجيل! ستتلقى إشعارات التحديثات.';
        document.getElementById('status').style.color = 'green';
      } else {
        throw new Error('فشل في توليد الـ token');
      }
    } else {
      document.getElementById('status').textContent = 'الإشعارات محظورة – فعلها من إعدادات المتصفح.';
      document.getElementById('status').style.color = 'orange';
    }
  } catch (error) {
    console.error('خطأ في الاشتراك:', error);
    document.getElementById('status').textContent = 'خطأ في التسجيل – جرب مرة أخرى.';
    document.getElementById('status').style.color = 'red';
  }
}

/* دالة إرسال إشعار (محدثة للإرسال عبر FCM REST API مع Server Key) */
async function sendNotification() {
  if (!messaging || SERVER_KEY === 'YOUR_ACTUAL_SERVER_KEY_HERE') {
    alert('Server Key غير محدد – استخدم Firebase Console للإرسال اليدوي أو أضف الـ Key.');
    return;
  }
  const message = {
    notification: {
      title: 'تحديث جدول المحاضرات! 🔔',
      body: 'تم تغيير مواعيد أو إضافة محاضرات جديدة – افتح الموقع للرؤية.'
    },
        topic: 'jadwal-updates'
  };
  try {
    const response = await fetch('https://fcm.googleapis.com/fcm/send', {
      method: 'POST',
      headers: {
        'Authorization': `key=${SERVER_KEY}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(message)
    });
    if (response.ok) {
      console.log('إشعار مرسل بنجاح!');
      alert('تم إرسال الإشعار للطلبة!');
    } else {
      throw new Error('فشل في الإرسال: ' + response.status);
    }
  } catch (error) {
    console.error('خطأ في الإرسال:', error);
    alert('خطأ في الإرسال – جرب من Firebase Console أو استخدم Cloud Functions.');
  }
}

/* Render weekly table (مصححة مع إصلاح title element) */
function renderTable(){
  const container=document.getElementById('tableContainer'); 
  if(!container) return; 
  container.innerHTML='';
  const table=document.createElement('table'); 
  table.className='table';
  const thead=document.createElement('thead'); 
  const headRow=document.createElement('tr'); 
  headRow.appendChild(document.createElement('th'));  // عمود اليوم فقط
  HOURS.forEach((h,idx)=>{
    const th=document.createElement('th'); 
    const next = HOURS[idx+1] || (h+1); 
    th.innerText = displayHour(h) + ' - ' + displayHour(next); 
    headRow.appendChild(th); 
  });
  thead.appendChild(headRow); 
  table.appendChild(thead);
  const tbody=document.createElement('tbody');
  const map={};
  (DATA.lectures||[]).forEach(l=>{ if (!l.day) return; map[l.day]=map[l.day]||[]; map[l.day].push(l); });
  DAYS.forEach(day=>{
    const tr=document.createElement('tr'); 
    const dayCell=document.createElement('th'); 
    dayCell.innerText=day; 
    tr.appendChild(dayCell);
    const occ = new Array(HOURS.length).fill(null);
        (map[day]||[]).forEach(l=>{
      const startNum = l.startHour + ((l.startMin||0)/60);
      const endNum = l.endHour + ((l.endMin||0)/60);
      const startIdx = Math.max(0, Math.floor(startNum - HOURS[0]));
      const span = Math.max(1, Math.ceil(endNum - startNum));
      if(startIdx < occ.length){
        occ[startIdx] = occ[startIdx] || [];
        occ[startIdx].push({lec:l, span:span});
        for(let k=1;k<span && (startIdx+k)<occ.length;k++) occ[startIdx+k] = 'skip';
      }
    });
    for(let i=0;i<HOURS.length;i++){
      const cell = occ[i];
      if(cell === 'skip') continue;
      const td=document.createElement('td');
      if(cell === null){
        td.innerHTML = '<div class="slot empty">'+displayHour(HOURS[i])+' — فارغ</div>';
        tr.appendChild(td);
      } else {
        const maxSpan = Math.max(...cell.map(c=>c.span));
        if(maxSpan>1) td.colSpan = maxSpan;
        const box=document.createElement('div');
        cell.forEach(cobj=>{
          const lec = cobj.lec;
          const col = genColor(lec.title);
          const div=document.createElement('div'); 
          div.className='slot'; 
          div.style.background = col.bg; 
          div.style.borderRadius='8px'; 
          div.style.padding='6px'; 
          div.style.marginBottom='6px';

          // إصلاح: إنشاء title بشكل صحيح
          const title = document.createElement('div');
          title.style.fontWeight = '800';
          title.style.color = col.solid;
          title.innerText = lec.title;

          const meta=document.createElement('div'); 
          meta.className='meta'; 
          // معالجة الرابط: لو location رابط، اعرض "أونلاين"، وأضف رابط clickable تحت
          let locationText = lec.location || 'غير محدد';
          let isLink = false;
          if (lec.location && (lec.location.startsWith('http://') || lec.location.startsWith('https://'))) {
            locationText = 'أونلاين';
            isLink = true;
          }
          meta.innerText = (getInstructorName(lec.instructorId)||lec.instructorName||'') + ' • ' + locationText;
          const timeEl=document.createElement('div'); 
          timeEl.className='meta'; 
          timeEl.innerText = to12WithMin(lec.startHour,lec.startMin||0) + ' — ' + to12WithMin(lec.endHour,lec.endMin||0);
          div.appendChild(title); 
          div.appendChild(meta); 
          div.appendChild(timeEl);
          // إضافة رابط clickable إذا كان رابط
          if (isLink) {
            const a=document.createElement('a'); 
            a.href=lec.location; 
            a.target='_blank'; 
            a.innerText='رابط المحاضرة'; 
            a.style.display='block'; 
            a.style.marginTop='6px'; 
            a.style.color = col.solid;
            a.style.textDecoration = 'none';
            a.style.fontSize = '12px';
            div.appendChild(a); 
          }
          // admin actions
          if(window.isAdmin){
            const actions=document.createElement('div'); 
            actions.style.marginTop='6px'; 
            actions.style.display='flex'; 
            actions.style.justifyContent='flex-end'; 
            actions.style.gap='6px';
            const delBtn=document.createElement('button'); 
            delBtn.className='small-btn admin-only';  // إضافة class للإخفاء
            delBtn.title='حذف'; 
            delBtn.innerText='🗑️';
            delBtn.onclick = (ev)=>{ 
              ev.stopPropagation(); 
              if(confirm('حذف المحاضرة؟')){ 
                const lecTitle = lec.title;
                DATA.lectures = DATA.lectures.filter(x=> x.id !== lec.id); 
                saveDataToLocal(); // حفظ محلي
                renderAll(); 
                recordChange('حُذفت المحاضرة: ' + lecTitle); 
                sendNotification();  // إرسال إشعار تلقائي عند الحذف
              } 
            };
            const editBtn=document.createElement('button'); 
            editBtn.className='small-btn admin-only';  // إضافة class للإخفاء
            editBtn.title='تعديل'; 
            editBtn.innerText='✏️';
            editBtn.onclick = (ev)=>{ 
              ev.stopPropagation(); 
              openEditModal(lec); 
            };
            actions.appendChild(editBtn); 
            actions.appendChild(delBtn);
            div.appendChild(actions);
          }
          if(isNowInLecture(lec)) div.classList.add('current');
          box.appendChild(div);
        });
        td.appendChild(box); 
        tr.appendChild(td);
        i += ((td.colSpan||1)-1);
      }
    }
    tbody.appendChild(tr);
  });
  table.appendChild(tbody); 
  container.appendChild(table); 
  renderLegend();
  renderLiveNotice();
  renderChangeLog();
}

/* Render day tabs and day view (مع إضافة admin-only classes) */
function renderDaysTabs(){
  const daysTabs=document.getElementById('daysTabs'); 
  if(!daysTabs) return;
  daysTabs.innerHTML='';
  DAYS.forEach(d=>{ 
    const btn=document.createElement('button'); 
    btn.className='day-tab'; 
    btn.innerText=d; 
    btn.onclick=()=> showDay(d); 
    daysTabs.appendChild(btn); 
  });
  // activate today by default (بتوقيت القاهرة)
  const todayIndex = getCairoDayIndex();
  const today = DAYS[todayIndex];
  showDay(today);
}

function showDay(day){
  document.querySelectorAll('.day-tab').forEach(b=> b.classList.toggle('active', b.innerText===day));
  const container=document.getElementById('dayContainer'); 
  if(!container) return;
  container.innerHTML='';
  const lectures=(DATA.lectures||[]).filter(l=> l.day===day).sort((a,b)=> (a.startHour+(a.startMin||0)/60)-(b.startHour+(b.startMin||0)/60));
  if(lectures.length===0){ 
    container.innerHTML='<div class="card">لا توجد محاضرات لهذا اليوم</div>'; 
    return; 
  }
  lectures.forEach(lec=>{
    const card=document.createElement('div'); 
    card.className='card'; 
    card.style.marginBottom='8px';
    const title=document.createElement('div'); 
    title.style.fontWeight='800'; 
    title.innerText=lec.title;
    const meta=document.createElement('div'); 
    meta.className='kv'; 
    // معالجة الرابط: لو location رابط، اعرض "أونلاين"، وأضف رابط clickable تحت
    let locationText = lec.location || 'غير محدد';
    let isLink = false;
    if (lec.location && (lec.location.startsWith('http://') || lec.location.startsWith('https://'))) {
      locationText = 'أونلاين';
      isLink = true;
    }
    meta.innerText=(getInstructorName(lec.instructorId)||lec.instructorName||'') + ' • ' + locationText;
    const timeEl=document.createElement('div'); 
    timeEl.className='kv'; 
    timeEl.innerText = to12WithMin(lec.startHour,lec.startMin||0) + ' — ' + to12WithMin(lec.endHour,lec.endMin||0);
    card.appendChild(title); 
    card.appendChild(meta); 
    card.appendChild(timeEl);
    // إضافة رابط clickable إذا كان رابط
    if (isLink) {
      const a=document.createElement('a'); 
      a.href=lec.location; 
      a.target='_blank'; 
      a.innerText='رابط المحاضرة'; 
      a.style.display='block'; 
      a.style.marginTop='6px'; 
      a.style.color = 'var(--accent1)';
      a.style.textDecoration = 'none';
      card.appendChild(a); 
    }
    // admin actions
    if(window.isAdmin){
      const actions = document.createElement('div'); 
      actions.style.marginTop='8px'; 
      actions.style.display='flex'; 
      actions.style.justifyContent='flex-end'; 
      actions.style.gap='6px';
      const delBtn = document.createElement('button'); 
      delBtn.className='small-btn admin-only';  // إضافة class للإخفاء
      delBtn.innerText='🗑️'; 
      delBtn.onclick=()=>{ 
        if(confirm('حذف المحاضرة؟')){ 
          const lecTitle = lec.title;
          DATA.lectures = DATA.lectures.filter(x=> x.id !== lec.id); 
          saveDataToLocal(); // حفظ محلي
          renderAll(); 
          recordChange('حُذفت المحاضرة: '+lecTitle); 
          sendNotification();  // إرسال إشعار تلقائي
        } 
      };
      const editBtn = document.createElement('button'); 
      editBtn.className='small-btn admin-only';  // إضافة class للإخفاء
      editBtn.innerText='✏️'; 
      editBtn.onclick=()=>{ openEditModal(lec); };
      actions.appendChild(editBtn); 
      actions.appendChild(delBtn); 
      card.appendChild(actions);
    }
    if(isNowInLecture(lec)) card.classList.add('current');
    container.appendChild(card);
  });
}

/* Render instructors */
function getInstructorName(id){ if(!id) return null; const i = DATA.instructors.find(x=>x.id===id); return i?i.name:null; }
function renderInstructors(){ 
  const list=document.getElementById('instructorList'); 
  if(!list) return;
  list.innerHTML=''; 
  if(DATA.instructors.length===0){ 
    list.innerHTML='<div class="card">لا يوجد دكاترة حتى الآن</div>'; 
    return; 
  } 
  DATA.instructors.forEach(i=>{ 
    const c=document.createElement('div'); 
    c.className='card'; 
    c.innerHTML='<div style="font-weight:800">'+escapeHtml(i.name)+'</div><div class="kv">'+escapeHtml(i.title||'')+'</div>' + (i.subjects?('<div class="kv">المواد: '+escapeHtml(i.subjects.join(', '))+'</div>'):''); 
    list.appendChild(c); 
  }); 
}

/* Legend */
function renderLegend(){ 
  const legend=document.getElementById('legend'); 
  if(!legend) return;
  legend.innerHTML=''; 
  const titles=Array.from(new Set(DATA.lectures.map(l=>l.title).filter(Boolean))); 
  titles.forEach(t=>{ 
    const el=document.createElement('div'); 
    el.className='legend-item'; 
    const col=genColor(t); 
    el.innerHTML='<span style="display:inline-block;width:12px;height:12px;background:'+col.solid+';border-radius:4px;margin-left:8px"></span>'+escapeHtml(t); 
    legend.appendChild(el); 
  }); 
}

/* Live check (بتوقيت القاهرة) */
function isNowInLecture(lec){ 
  if(!lec) return false; 
  const cairoNow = getCairoTime();
  const todayIndex = getCairoDayIndex();
  const today = DAYS[todayIndex]; 
  if(lec.day !== today) return false; 
  const start=new Date(cairoNow); 
  start.setHours(lec.startHour, lec.startMin||0,0,0); 
  const end=new Date(cairoNow); 
  end.setHours(lec.endHour, lec.endMin||0,0,0); 
  return cairoNow>=start && cairoNow<end; 
}

/* دالة timeRemaining (للعداد – محسنة لليوم/ساعة/دقيقة/ثانية) */
function timeRemaining(targetDate){ 
  const cairoNow = getCairoTime();
  const diff = Math.max(0, targetDate - cairoNow); 
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
  const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
  const seconds = Math.floor((diff % (1000 * 60)) / 1000);
  let timeStr = '';
  if (days > 0) timeStr += days + ' يوم ';
  if (hours > 0) timeStr += hours + ' ساعة ';
  if (minutes > 0 || (hours === 0 && days === 0)) timeStr += minutes + ' دقيقة ';
  if (seconds > 0 || timeStr === '') timeStr += seconds + ' ثانية';
  return timeStr.trim();
}

/* دالة عرض الإشعار العام في الهيدر (بتوقيت القاهرة) */
function renderLiveNotice() {
  const noticeEl = document.getElementById('liveNotice');
  if (!noticeEl) return;
  
  const cairoNow = getCairoTime();
  const todayIndex = getCairoDayIndex();
  const today = DAYS[todayIndex];
  const todayLectures = DATA.lectures.filter(l => l.day === today);
  
  if (todayLectures.length === 0) {
    noticeEl.innerText = 'لا توجد محاضرات اليوم';
    noticeEl.classList.remove('live-countdown', 'upcoming-soon', 'current');
    return;
  }
  
  const currentLecture = todayLectures.find(l => isNowInLecture(l));
  if (currentLecture) {
    noticeEl.innerText = `الآن: ${currentLecture.title}`;
    noticeEl.classList.add('current');
    noticeEl.classList.remove('live-countdown', 'upcoming-soon');
  } else {
    // أقرب محاضرة اليوم
    const nextLecture = todayLectures.find(l => {
      const lecDate = new Date(cairoNow);
      lecDate.setHours(l.startHour, l.startMin || 0, 0, 0);
      return lecDate > cairoNow;
    });
    if (nextLecture) {
      const lecDate = new Date(cairoNow);
      lecDate.setHours(nextLecture.startHour, nextLecture.startMin || 0, 0, 0);
      noticeEl.innerText = `${nextLecture.title}: بعد ${timeRemaining(lecDate)}`;
      noticeEl.classList.add('live-countdown');
      const diff = lecDate - cairoNow;
      if (diff < 300000) {  // أقل من 5 دقائق
        noticeEl.classList.add('upcoming-soon');
      } else {
        noticeEl.classList.remove('upcoming-soon');
      }
    } else {
      noticeEl.innerText = 'انتهت محاضرات اليوم';
      noticeEl.classList.remove('live-countdown', 'upcoming-soon', 'current');
    }
  }
}

/* Admin UI (مع أمان محسن + إرسال إشعار عند الحفظ) */
function openAdminFlow(){ 
  const root=document.getElementById('modalRoot'); 
  if(!root) return;
  root.innerHTML=''; 
  const wrap=document.createElement('div'); 
  wrap.className='modal-back'; 
  const m=document.createElement('div'); 
  m.className='modal'; 
  m.innerHTML='<h3>دخول لوحة الإدارة</h3><p class="kv">أدخل كلمة المرور (للأدمن فقط)</p><input id="pw" class="input" type="password" placeholder="كلمة مرور سرية" /><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px"><button id="cancelPw" class="btn">إلغاء</button><button id="submitPw" class="btn">دخول</button></div>'; 
  wrap.appendChild(m); 
  root.appendChild(wrap); 
  root.style.display='block'; 
  document.getElementById('cancelPw').onclick=()=>{ 
    root.style.display='none'; 
    root.innerHTML=''; 
  }; 
  document.getElementById('submitPw').onclick=()=>{ 
    const v=document.getElementById('pw').value; 
    if(v===ADMIN_PASSWORD){ 
      window.isAdmin = true; 
      root.style.display='none'; 
      root.innerHTML=''; 
      openAdmin(); updateAdminVisibility(); 
      recordChange('الأدمن دخل لوحة التحكم'); 
      console.log('Admin login successful'); // log للأمان
    } else { 
      const pwEl=document.getElementById('pw'); 
      pwEl.style.animation='shake 0.3s'; 
      setTimeout(()=> pwEl.style.animation='',350); 
      alert('كلمة المرور خاطئة! الوصول محظور.'); 
      console.log('Failed admin login attempt'); // log للأمان
    } 
  }; 
}

// Admin panel (مع إرسال إشعار عند الحفظ)
function openAdmin(){ 
  const root=document.getElementById('modalRoot'); 
  if(!root) return;
  root.innerHTML=''; 
  const wrap=document.createElement('div'); 
  wrap.className='modal-back'; 
  const m=document.createElement('div'); 
  m.className='modal'; 
  m.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center"><h3>لوحة الإدارة</h3><div><button id="saveBtn" class="btn">حفظ (يرسل إشعار)</button> <button id="closeBtn" class="btn">خروج</button></div></div><p class="kv">التعديلات محف وظة محليًا في متصفحك. لجعلها تظهر للجميع، استخدم "تصدير كود GitHub" في تبويب الاستيراد/تصدير، ثم انسخ الكود ولصقه في ملف HTML على GitHub وارفع.</p><div style="margin-top:12px"><div style="display:flex;gap:8px;margin-bottom:8px"><button id="tabLect" class="btn active">المحاضرات</button><button id="tabInst" class="btn">الدكاترة</button><button id="tabImp" class="btn">استيراد/تصدير</button></div><div id="adminBody"></div></div>'; 
  wrap.appendChild(m); 
  root.appendChild(wrap); 
  root.style.display='block'; 
  document.getElementById('closeBtn').onclick=()=>{ 
    window.isAdmin = false; 
    root.style.display='none'; 
    root.innerHTML=''; 
    updateAdminVisibility(); 
  }; 
  document.getElementById('saveBtn').onclick=()=>{ 
    saveDataToLocal(); // حفظ محلي
    sendNotification();  // إرسال إشعار تلقائي للطلبة
    alert('تم حفظ التعديلات محليًا وإرسال إشعار. للنشر للجميع، استخدم تصدير كود GitHub.'); 
    renderAll(); 
  }; 
  // تصحيح: استخدم functions منفصلة للـ onclick لتجنب التكرار والأخطاء
  function switchToLect() { 
    document.querySelectorAll('[id^="tab"]').forEach(b=>b.classList.remove('active')); 
    document.getElementById('tabLect').classList.add('active'); 
    renderAdminLectures(); 
  }
  function switchToInst() { 
    document.querySelectorAll('[id^="tab"]').forEach(b=>b.classList.remove('active')); 
    document.getElementById('tabInst').classList.add('active'); 
    renderAdminInstructors(); 
  }
  function switchToImp() { 
    document.querySelectorAll('[id^="tab"]').forEach(b=>b.classList.remove('active')); 
    document.getElementById('tabImp').classList.add('active'); 
    renderAdminImportExport(); 
  }
  document.getElementById('tabLect').onclick = switchToLect;
  document.getElementById('tabInst').onclick = switchToInst;
  document.getElementById('tabImp').onclick = switchToImp;
  loadDataFromLocal(); // حمّل البيانات المحلية عند الدخول
  renderAdminLectures(); // افتراضي: المحاضرات
}

function renderAdminLectures(){ 
  const body=document.getElementById('adminBody'); 
  if(!body) return;
  body.innerHTML='<div style="margin-bottom:12px"><h4>إضافة محاضرة جديدة</h4></div>'; 
  const form=document.createElement('form'); 
  const hourOptions=HOURS.map(h=>'<option value="'+h+'">'+to12(h)+'</option>').join(''); 
  const minuteOptions='<option value="0">00</option><option value="30">30</option>'; 
  const instOptions='<option value="">اختر دكتور (اختياري)</option>'+DATA.instructors.map(i=>'<option value="'+i.id+'">'+escapeHtml(i.name)+'</option>').join(''); 
  form.innerHTML='<div class="row"><div class="col"><label class="kv">اليوم</label><select id="fDay" class="input">'+DAYS.map(d=>'<option value="'+d+'">'+d+'</option>').join('')+'</select></div><div class="col"><label class="kv">بداية (ساعة/دقيقة)</label><div class="row"><select id="fStartH" class="input">'+hourOptions+'</select><select id="fStartM" class="input">'+minuteOptions+'</select></div></div></div><div class="row" style="margin-top:8px"><div class="col"><label class="kv">نهاية (ساعة/دقيقة)</label><div class="row"><select id="fEndH" class="input">'+hourOptions+'</select><select id="fEndM" class="input">'+minuteOptions+'</select></div></div><div class="col"><label class="kv">المادة</label><input id="fTitle" class="input" placeholder="اسم المادة" required /></div></div><div style="margin-top:8px" class="row"><div class="col"><label class="kv">الدكتور (اختياري)</label><select id="fInst" class="input">'+instOptions+'</select></div><div class="col"><label class="kv">المكان أو رابط</label><input id="fLocation" class="input" placeholder="المكان (قاعة) أو رابط المحاضرة" /></div></div><textarea id="fNotes" class="input" placeholder="ملاحظات"></textarea><div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn" type="submit">أضف المحاضرة</button></div>'; 
  body.appendChild(form); 
  form.onsubmit=(e)=>{ 
    e.preventDefault(); 
    const day=document.getElementById('fDay').value; 
    const sh=+document.getElementById('fStartH').value; 
    const sm=+document.getElementById('fStartM').value; 
    const eh=+document.getElementById('fEndH').value; 
    const em=+document.getElementById('fEndM').value; 
    let startNum=sh + (sm/60); 
    let endNum=eh + (em/60); 
    if(endNum<=startNum) { 
      alert('وقت النهاية يجب أن يكون بعد وقت البداية'); 
      return; 
    } 
    const startHour=Math.floor(startNum); 
    const endHour=Math.floor(endNum); 
    const lec={ 
      id: uid(), 
      day, 
      startHour, 
      startMin: sm, 
      endHour, 
      endMin: em, 
      title: document.getElementById('fTitle').value.trim(), 
      instructorId: document.getElementById('fInst').value || null, 
      instructorName: null, 
      location: document.getElementById('fLocation').value.trim(), 
      notes: document.getElementById('fNotes').value.trim(), 
      link: '' 
    }; 
    DATA.lectures.push(lec); 
    saveDataToLocal(); // حفظ محلي
    recordChange('أُضيفت محاضرة جديدة: ' + lec.title); 
    renderAdminLectures(); 
    renderAll(); 
    sendNotification();  // إرسال إشعار تلقائي عند الإضافة
    alert('تم الإضافة وحفظها محليًا وإرسال إشعار. للنشر للجميع، استخدم تصدير كود GitHub.'); 
  }; 
  const list=document.createElement('div'); 
  list.style.marginTop='12px'; 
  if(DATA.lectures.length===0) { 
    list.innerHTML='<div class="card">لا توجد محاضرات بعد</div>'; 
  } else { 
    const ul=document.createElement('div'); 
    ul.style.display='grid'; 
    ul.style.gap='8px'; 
    DATA.lectures.forEach(l=>{ 
      const el=document.createElement('div'); 
      el.className='card'; 
      const instName=getInstructorName(l.instructorId) || l.instructorName || ''; 
      el.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:800">'+escapeHtml(l.title)+'</div><div class="kv">'+escapeHtml(l.day)+' '+to12WithMin(l.startHour,l.startMin)+' — '+to12WithMin(l.endHour,l.endMin)+' • '+escapeHtml(instName)+'</div></div><div><button class="btn small admin-only" data-id="'+l.id+'">حذف</button> <button class="btn small admin-only" data-edit="'+l.id+'">تعديل</button></div></div>'; 
      ul.appendChild(el); 
    }); 
    list.appendChild(ul); 
    // delete buttons
    list.querySelectorAll('button[data-id]').forEach(b=> b.addEventListener('click', ()=>{ 
      const id=b.getAttribute('data-id'); 
      if(confirm('حذف المحاضرة؟')){ 
        const lecTitle = DATA.lectures.find(x=>x.id===id)?.title || 'غير معروف'; 
        DATA.lectures = DATA.lectures.filter(x=> x.id !== id); 
        saveDataToLocal(); // حفظ محلي
        renderAdminLectures(); 
        renderAll(); 
        recordChange('حُذفت محاضرة: ' + lecTitle); 
        sendNotification();  // إرسال إشعار تلقائي
        alert('تم الحذف وحفظه محليًا وإرسال إشعار. للنشر للجميع، استخدم تصدير كود GitHub.'); 
      } 
    })); 
    // edit buttons
    list.querySelectorAll('button[data-edit]').forEach(b=> b.addEventListener('click', ()=>{ 
      const id=b.getAttribute('data-edit'); 
      const lec = DATA.lectures.find(x=>x.id===id); 
      if(lec) openEditModal(lec); 
    })); 
  } 
  body.appendChild(list); 
}

function renderAdminInstructors(){ 
  const body=document.getElementById('adminBody'); 
  if(!body) return;
  body.innerHTML='<div style="margin-bottom:12px"><h4>إضافة دكتور جديد</h4></div>'; 
  const form=document.createElement('form'); 
  form.innerHTML='<div class="row"><div class="col"><input id="iName" class="input" placeholder="اسم الدكتور" required /></div><div class="col"><input id="iTitle" class="input" placeholder="التخصص/المسمى" /></div></div><input id="iSubjects" class="input" placeholder="المواد (افصل بفاصلة)" /><textarea id="iBio" class="input" placeholder="نبذة عن الدكتور"></textarea><div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn" type="submit">أضف الدكتور</button></div>'; 
  body.appendChild(form); 
  form.onsubmit=(e)=>{ 
    e.preventDefault(); 
    const inst={ 
      id: uid(), 
      name: document.getElementById('iName').value.trim(), 
      title: document.getElementById('iTitle').value.trim(), 
      subjects: document.getElementById('iSubjects').value.split(',').map(s=>s.trim()).filter(Boolean), 
      bio: document.getElementById('iBio').value.trim() 
    }; 
    if(!inst.name){ alert('اسم الدكتور مطلوب'); return; } 
    DATA.instructors.push(inst); 
    saveDataToLocal(); // حفظ محلي
    recordChange('أُضيف دكتور جديد: ' + inst.name); 
    renderAdminInstructors(); 
    renderAll(); 
    sendNotification();  // إرسال إشعار تلقائي
    alert('تم الإضافة وحفظها محليًا وإرسال إشعار. للنشر للجميع، استخدم تصدير كود GitHub.'); 
  }; 
  const list=document.createElement('div'); 
  list.style.marginTop='12px'; 
  if(DATA.instructors.length===0) { 
    list.innerHTML='<div class="card">لا يوجد دكاترة حتى الآن</div>'; 
  } else { 
    const ul=document.createElement('div'); 
    ul.style.display='grid'; 
    ul.style.gap='8px'; 
    DATA.instructors.forEach(i=>{ 
      const el=document.createElement('div'); 
      el.className='card'; 
      el.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:800">'+escapeHtml(i.name)+'</div><div class="kv">'+escapeHtml(i.title||'')+'</div></div><div><button class="btn small admin-only" data-id="'+i.id+'">حذف</button> <button class="btn small admin-only" data-edit="'+i.id+'">تعديل</button></div></div>'; 
      ul.appendChild(el); 
    }); 
    list.appendChild(ul); 
    // delete buttons
    list.querySelectorAll('button[data-id]').forEach(b=> b.addEventListener('click', ()=>{ 
      const id=b.getAttribute('data-id'); 
      if(confirm('حذف الدكتور؟')){ 
        const instName = DATA.instructors.find(x=>x.id===id)?.name || ''; 
        DATA.instructors = DATA.instructors.filter(x=> x.id!==id); 
        saveDataToLocal(); // حفظ محلي
        renderAdminInstructors(); 
        renderAll(); 
        recordChange('حُذف الدكتور: ' + instName); 
        sendNotification();  // إرسال إشعار تلقائي
        alert('تم الحذف وحفظه محليًا وإرسال إشعار. للنشر للجميع، استخدم تصدير كود GitHub.'); 
      } 
    })); 
    // edit buttons (بسيطة – يمكن توسيعها لاحقًا)
    list.querySelectorAll('button[data-edit]').forEach(b=> b.addEventListener('click', ()=>{ 
      const id=b.getAttribute('data-edit'); 
      const inst = DATA.instructors.find(x=>x.id===id); 
      if(inst) {
        // modal بسيط للتعديل (يمكن تحسينه)
        const newName = prompt('اسم الدكتور الجديد:', inst.name);
        if (newName && newName.trim() !== inst.name) {
          inst.name = newName.trim();
          saveDataToLocal();
          renderAll();
          recordChange('تم تعديل الدكتور: ' + inst.name);
          sendNotification();
          alert('تم التعديل!');
        }
      }
    })); 
  } 
  body.appendChild(list); 
}

function renderAdminImportExport(){ 
  const body=document.getElementById('adminBody'); 
  if(!body) return;
  body.innerHTML='<div style="margin-bottom:12px"><h4>نسخ احتياطي ونشر</h4><p class="kv">لجعل التعديلات تظهر للجميع، استخدم "إنشاء كود GitHub" لنسخ الكود الجاهز، ثم لصقه في ملف HTML على GitHub وارفع.</p></div>'; 
  const exportJsonBtn=document.createElement('button'); 
  exportJsonBtn.className='btn'; 
  exportJsonBtn.innerText='تحميل JSON'; 
  exportJsonBtn.onclick=()=>{ 
    const a=document.createElement('a'); 
    const blob=new Blob([JSON.stringify(DATA, null, 2)],{type:'application/json'}); 
    a.href=URL.createObjectURL(blob); 
    a.download='jadwal-backup.json'; 
    a.click(); 
    alert('تم تحميل JSON. استخدمه للاستيراد أو تعديل الكود.'); 
  }; 
  const generateCodeBtn=document.createElement('button'); 
  generateCodeBtn.className='btn'; 
  generateCodeBtn.style.marginRight='8px'; 
    generateCodeBtn.innerText='إنشاء كود GitHub'; 
  generateCodeBtn.onclick=()=>{ 
    const code = `let DATA = {
  lectures: ${JSON.stringify(DATA.lectures, null, 2)},
  instructors: ${JSON.stringify(DATA.instructors, null, 2)},
  changes: []
};`;
    navigator.clipboard.writeText(code).then(() => {
      alert('تم نسخ كود DATA الجاهز! لصقه في ملف HTML تحت /* بيانات افتراضية ثابتة */، ثم ارفع على GitHub ليظهر للجميع.');
    }).catch(() => {
      // fallback إذا مش بيشتغل clipboard
      const ta = document.createElement('textarea');
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      alert('تم نسخ كود DATA! لصقه في ملف HTML، ثم ارفع على GitHub.');
    });
  }; 
  const importBtn=document.createElement('button'); 
  importBtn.className='btn'; 
  importBtn.style.marginRight='8px'; 
  importBtn.innerText='استيراد JSON'; 
  importBtn.onclick=()=>{ 
    const inp=document.createElement('input'); 
    inp.type='file'; 
    inp.accept='application/json'; 
    inp.onchange=()=>{ 
      const f=inp.files[0]; 
      if(!f) return; 
      const reader=new FileReader(); 
      reader.onload=()=>{ 
        try{ 
          const newData = JSON.parse(reader.result); 
          if(newData.lectures && newData.instructors){ 
            DATA = newData; 
            saveDataToLocal(); // حفظ محلي
            renderAll(); 
            sendNotification();  // إرسال إشعار بعد الاستيراد
            alert('تم الاستيراد وحفظه محليًا وإرسال إشعار. للنشر للجميع، استخدم إنشاء كود GitHub.'); 
          } else { 
            alert('الملف غير صحيح'); 
          } 
        }catch(e){ 
          alert('ملف غير صحيح: ' + e.message); 
        } 
      }; 
      reader.readAsText(f); 
    }; 
    inp.click(); 
  }; 
  const clearBtn=document.createElement('button'); 
  clearBtn.className='btn'; 
  clearBtn.style.background='red'; 
  clearBtn.style.color='white'; 
  clearBtn.innerText='مسح كل البيانات'; 
  clearBtn.onclick=()=>{ 
    if(confirm('هل أنت متأكد؟ سيتم مسح كل المحاضرات والدكاترة!')){ 
      DATA = {lectures:[], instructors:[], changes:[]}; 
      saveDataToLocal(); // حفظ محلي
      renderAll(); 
      recordChange('تم مسح كل البيانات'); 
      sendNotification();  // إرسال إشعار تلقائي
      alert('تم المسح وحفظه محليًا وإرسال إشعار. للنشر للجميع، استخدم إنشاء كود GitHub.'); 
    } 
  }; 
  body.appendChild(generateCodeBtn); 
  body.appendChild(importBtn); 
  body.appendChild(exportJsonBtn); 
  body.appendChild(clearBtn); 
}

/* Edit Modal (مصححة مع إصلاح endMinuteOptions) */
function openEditModal(lec){
  const root=document.getElementById('modalRoot'); 
  if(!root) return; 
  root.innerHTML='';
  const wrap=document.createElement('div'); 
  wrap.className='modal-back'; 
  const m=document.createElement('div'); 
  m.className='modal';
  const hourOptions=HOURS.map(h=>'<option '+(h===lec.startHour?'selected':'')+' value="'+h+'">'+to12(h)+'</option>').join('');
  const minuteOptions='<option '+( (lec.startMin||0)===0 ? 'selected' : '' )+' value="0">00</option><option '+( (lec.startMin||0)===30 ? 'selected' : '' )+' value="30">30</option>';
  m.innerHTML = '<h3>تعديل المحاضرة</h3>';
  m.innerHTML += '<div class="row"><div class="col"><label class="kv">اليوم</label><select id="eDay" class="input">'+DAYS.map(d=>'<option '+(d===lec.day?'selected':'')+' value="'+d+'">'+d+'</option>').join('')+'</select></div><div class="col"><label class="kv">بداية (ساعة/دقيقة)</label><div class="row"><select id="eStartH" class="input">'+hourOptions+'</select><select id="eStartM" class="input">'+minuteOptions+'</select></div></div></div>';
  // إصلاح: endMinuteOptions صحيحة الآن
  const endMinuteOptions='<option '+( (lec.endMin||0)===0 ? 'selected' : '' )+' value="0">00</option><option '+( (lec.endMin||0)===30 ? 'selected' : '' )+' value="30">30</option>';
  const endHourOptions=HOURS.map(h=>'<option '+(h===lec.endHour?'selected':'')+' value="'+h+'">'+to12(h)+'</option>').join('');
  m.innerHTML += '<div class="row" style="margin-top:8px"><div class="col"><label class="kv">نهاية (ساعة/دقيقة)</label><div class="row"><select id="eEndH" class="input">'+endHourOptions+'</select><select id="eEndM" class="input">'+endMinuteOptions+'</select></div></div><div class="col"><label class="kv">المادة</label><input id="eTitle" class="input" value="'+escapeHtml(lec.title||'')+'" /></div></div>'; 
  m.innerHTML += '<div style="margin-top:8px" class="row"><div class="col"><label class="kv">الدكتور (اختياري)</label><select id="eInst" class="input"><option value="">اختر دكتور (اختياري)</option>'+ (DATA.instructors.map(i=>'<option '+(i.id===lec.instructorId?'selected':'')+' value="'+i.id+'">'+escapeHtml(i.name)+'</option>').join('')) + '</select></div><div class="col"><label class="kv">المكان أو رابط</label><input id="eLocation" class="input" value="'+escapeHtml(lec.location||'')+'" /></div></div>'; 
  m.innerHTML += '<textarea id="eNotes" class="input" placeholder="ملاحظات">'+escapeHtml(lec.notes||'')+'</textarea><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px"><button id="cancelEdit" class="btn">إلغاء</button><button id="saveEdit" class="btn">حفظ التعديل</button></div>'; 
  wrap.appendChild(m); 
  root.appendChild(wrap); 
  root.style.display='block';
  document.getElementById('cancelEdit').onclick=()=>{ 
    root.style.display='none'; 
    root.innerHTML=''; 
  };
  document.getElementById('saveEdit').onclick=()=>{
    const day=document.getElementById('eDay').value;
    const sh=+document.getElementById('eStartH').value; 
    const sm=+document.getElementById('eStartM').value;
    const eh=+document.getElementById('eEndH').value; 
    const em=+document.getElementById('eEndM').value;
    const title=document.getElementById('eTitle').value.trim();
    const inst=document.getElementById('eInst').value || null;
    const loc=document.getElementById('eLocation').value.trim();
    const notes=document.getElementById('eNotes').value.trim();
    let startNum=sh + (sm/60); 
    let endNum=eh + (em/60); 
    if(endNum<=startNum) { 
      alert('وقت النهاية يجب أن يكون بعد وقت البداية'); 
      return; 
    } 
    const startHour=Math.floor(startNum); 
    const endHour=Math.floor(endNum); 
    const idx = DATA.lectures.findIndex(x=> x.id===lec.id);
    if(idx>-1){
      DATA.lectures[idx].day = day;
      DATA.lectures[idx].startHour = startHour; 
      DATA.lectures[idx].startMin = sm;
      DATA.lectures[idx].endHour = endHour; 
      DATA.lectures[idx].endMin = em;
      DATA.lectures[idx].title = title;
      DATA.lectures[idx].instructorId = inst;
      DATA.lectures[idx].location = loc;
      DATA.lectures[idx].notes = notes;
      saveDataToLocal(); // حفظ محلي
      recordChange('تم تعديل المحاضرة: ' + title);
      renderAll();
      sendNotification();  // إرسال إشعار تلقائي عند التعديل
      alert('تم التعديل وحفظه محليًا وإرسال إشعار. للنشر للجميع، استخدم تصدير كود GitHub.');
    }
    root.style.display='none'; 
    root.innerHTML='';
  };
}

/* Change log (محفوظ محليًا) */
function recordChange(msg){
  try{
    const now = new Date();
    DATA.changes = DATA.changes || [];
    DATA.changes.unshift({ts: now.toISOString(), msg: msg});
    if(DATA.changes.length>300) DATA.changes.length = 300;
    saveDataToLocal(); // حفظ محلي
    renderChangeLog();
  }catch(e){ console.error('recordChange error:', e); }
}

function renderChangeLog(){
  try{
    const footer = document.querySelector('.footer'); 
    if(!footer) return;
    let wrap = document.getElementById('changeLogWrap');
    if(!wrap){
      wrap = document.createElement('div'); 
      wrap.id='changeLogWrap'; 
      wrap.className='card'; 
      wrap.style.marginTop='12px'; 
      footer.parentNode.insertBefore(wrap, footer); 
    }
    const groups = {};
    (DATA.changes||[]).forEach(ch=>{ 
      const d = (ch.ts||'').slice(0,10) || 'unknown'; 
      groups[d] = groups[d] || []; 
      groups[d].push(ch); 
    });
    let html = '<h4>سجل التعديلات</h4><p class="kv">السجل محفوظ محليًا في متصفحك.</p>';
    if(Object.keys(groups).length===0) { 
      html += '<div class="kv">لم يتم إجراء تعديلات بعد</div>'; 
    } else {
      Object.keys(groups).sort((a,b)=> b.localeCompare(a)).forEach(date=>{
        html += '<div style="margin-top:8px"><div style="font-weight:800">'+date+'</div><ul style="margin:6px 0 0 16px">';
        groups[date].forEach(g=>{ 
          const time = (g.ts||'').slice(11,19); 
          html += '<li class="kv">'+time+' — '+escapeHtml(g.msg)+'</li>'; 
        });
        html += '</ul></div>';
      });
    }
    wrap.innerHTML = html;
  }catch(e){ console.error('renderChangeLog error:', e); }
}

function updateAdminVisibility(){
  // إخفاء/إظهار أزرار الإدارة (محسنة لتشمل .admin-only)
  const adminElements = document.querySelectorAll('.admin-only');
  adminElements.forEach(el => el.style.display = window.isAdmin ? 'inline-block' : 'none');
}

/* Export/Import/Print handlers (مع التركيز على النسخ الاحتياطي + تكامل الإشعار) */
function initHandlers(){
  // Export (للنسخ الاحتياطي لتعديل الكود)
  const exportBtn = document.getElementById('exportBtn');
  if(exportBtn) exportBtn.addEventListener('click', ()=>{ 
    const a=document.createElement('a'); 
    const blob=new Blob([JSON.stringify(DATA, null, 2)],{type:'application/json'}); 
    a.href=URL.createObjectURL(blob); 
    a.download='jadwal-backup.json'; 
    a.click(); 
    alert('استخدم هذا الملف للاستيراد أو تعديل DATA في الكود، ثم ارفع على GitHub للـ sharing.'); 
  });

  // Import (محلي)
  const importBtn = document.getElementById('importBtn');
  if(importBtn) importBtn.addEventListener('click', ()=>{ 
    const inp=document.createElement('input'); 
    inp.type='file'; 
    inp.accept='application/json'; 
    inp.onchange=()=>{ 
      const f=inp.files[0]; 
      if(!f) return; 
      const reader=new FileReader(); 
      reader.onload=()=>{ 
        try{ 
          const newData = JSON.parse(reader.result); 
          if(newData.lectures && newData.instructors){ 
            DATA = newData; 
            saveDataToLocal(); // حفظ محلي
            renderAll(); 
            sendNotification();  // إرسال إشعار بعد الاستيراد
            alert('تم الاستيراد وحفظه محليًا وإرسال إشعار. للـ sharing، استخدم لوحة الإدارة > استيراد/تصدير > إنشاء كود GitHub.'); 
          } else { 
            alert('الملف غير صحيح'); 
          } 
        }catch(e){ 
          alert('ملف غير صحيح: ' + e.message); 
        } 
      }; 
      reader.readAsText(f); 
    }; 
    inp.click(); 
  });

  // Print (مع styles محسنة)
  const printBtn = document.getElementById('printBtn');
  if(printBtn) printBtn.addEventListener('click', ()=>{ 
    const w=window.open('','_blank'); 
    const printStyles = `
      body { font-family: 'Cairo', Arial, sans-serif; direction: rtl; padding: 16px; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
      th { background: #f0f0f0; }
      .slot { padding: 4px; border-radius: 4px; margin: 2px; }
      .current { outline: 2px solid #7c3aed; }
      .live-countdown { font-weight: bold; color: #dc3545; }  /* ستايل للعداد في الطباعة */
    `;
    w.document.open(); 
    w.document.write('<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8"/><title>جدول المحاضرات</title><style>'+printStyles+'</style><link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet"></head><body><h2>جدول المحاضرات</h2>'+document.getElementById('tableContainer').innerHTML+'<p style="margin-top:20px">تصميم وبرمجة: Khaled El-Reweni 💻</p></body></html>'); 
    w.document.close(); 
    setTimeout(()=>{ w.print(); }, 500); 
  });

  // Admin (مع أمان)
  const adminBtn = document.getElementById('adminBtn');
  if(adminBtn) adminBtn.addEventListener('click', openAdminFlow);

  // Theme toggle (محلي لكل مستخدم)
  const themeToggle = document.getElementById('themeToggle');
  if(themeToggle) themeToggle.addEventListener('click', ()=>{ 
    const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', newTheme);
    saveTheme(newTheme);
  });

  // Load theme
  const savedTheme = loadTheme();
  if(savedTheme === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
}

/* Tab switching */
function initTabs(){
  document.querySelectorAll('.tab-btn').forEach(b=> b.addEventListener('click', ()=>{ 
    document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active')); 
    b.classList.add('active'); 
    const tab=b.getAttribute('data-tab'); 
    document.getElementById('tab-weekly').style.display = tab==='weekly' ? 'block' : 'none'; 
    document.getElementById('tab-day').style.display = tab==='day' ? 'block' : 'none'; 
    document.getElementById('tab-instructors').style.display = tab==='instructors' ? 'block' : 'none'; 
  }));
}

function renderAll(){
  renderTable();
  renderDaysTabs();
  renderInstructors();
  renderLiveNotice();
  renderChangeLog();
  updateAdminVisibility();
  // إصلاح: بدء تحديث العداد في الهيدر (كل دقيقة) – الشرط صحيح الآن
  if (typeof noticeInterval === 'undefined') {
    noticeInterval = setInterval(() => {
      renderLiveNotice();  // تحديث الإشعار العام فقط
    }, 60000);  // كل دقيقة
  }
}

// Initialization
document.addEventListener('DOMContentLoaded', ()=>{ 
  loadDataFromLocal(); // حمّل البيانات المحلية أولاً
  initHandlers(); 
  initTabs(); 
  renderAll(); 
  // حدث الإشعار كل دقيقة للكشف عن المحاضرات الحالية
  if (typeof noticeInterval === 'undefined') {
    noticeInterval = setInterval(() => {
      renderLiveNotice();  // تحديث الإشعار العام فقط
    }, 60000);  // كل دقيقة
  }
  // للعداد الدقيق (ثواني) في upcoming lectures، حدث كل ثانية
  if (typeof countdownInterval === 'undefined') {
    countdownInterval = setInterval(() => {
      const noticeEl = document.getElementById('liveNotice');
      if (noticeEl && noticeEl.classList.contains('live-countdown')) {
        renderLiveNotice();  // إعادة رسم العداد الدقيق
      }
    }, 1000);  // كل ثانية للدقة في الثواني
  }
  // تحقق تلقائي من الإشعارات عند التحميل (إذا كان permission granted)
  if (messaging && Notification.permission === 'granted') {
    requestPermission();  // تحديث الـ token تلقائيًا
  }
});

// تنظيف الـ intervals عند إغلاق الصفحة (اختياري للأداء)
window.addEventListener('beforeunload', () => {
  if (typeof noticeInterval !== 'undefined') clearInterval(noticeInterval);
  if (typeof countdownInterval !== 'undefined') clearInterval(countdownInterval);
});
</script>
</body>
</html>
