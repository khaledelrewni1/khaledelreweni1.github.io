<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>جدول المحاضرات</title>
<link rel="icon" href="icons/favicon.png">
<style>
:root{
  --bg:#f1f5f9; --card:#ffffff; --muted:#6b7280; --accent1:#60a5fa; --accent2:#7c3aed;
  --text:#0f172a; --glass: rgba(255,255,255,0.6);
}
[data-theme="dark"]{
  --bg:#0b1220; --card:#071127; --muted:#9ca3af; --text:#e6eef8; --glass: rgba(255,255,255,0.04);
}
*{box-sizing:border-box}
body{margin:0;font-family: 'Cairo', sans-serif;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:var(--text);min-height:100vh;}
.container{max-width:1100px;margin:0 auto;padding:16px;}
.header{background:transparent;padding:18px;border-radius:14px;color:white}
.header-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:10px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;font-size:28px}
.title{font-size:22px;font-weight:700}
.subtitle{opacity:0.9;font-size:13px}
.controls{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
.btn{background:white;color:#3730a3;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
.info-badge{background:rgba(255,255,255,0.18);padding:6px 10px;border-radius:8px;font-size:13px}
.nav{display:flex;gap:8px;margin:16px 0}
.nav button{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;background:rgba(255,255,255,0.9)}
.nav button.active{background:rgba(255,255,255,0.18);color:white}

.card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(2,6,23,0.12);color:var(--text)}
.grid{display:grid;gap:12px}
.grid-cols-3{grid-template-columns:repeat(3,1fr)}
.day-column{min-height:120px}
.slot{padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.03);display:flex;justify-content:space-between;align-items:center;gap:8px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.02))}
.slot.empty{opacity:0.6}
.slot .left{display:flex;flex-direction:column;align-items:flex-end}
.slot .title{font-weight:700}
.slot .meta{font-size:12px;color:var(--muted)}
.footer{padding:12px;text-align:center;color:rgba(255,255,255,0.9);opacity:0.9}

.admin-bar{position:fixed;left:16px;bottom:16px}
.fab{background:var(--card);padding:10px 14px;border-radius:999px;box-shadow:0 8px 24px rgba(2,6,23,0.16);cursor:pointer;border:none}
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;padding:16px}
.modal{width:100%;max-width:720px;background:var(--card);border-radius:12px;padding:16px;color:var(--text);max-height:90vh;overflow:auto}
.input, textarea, select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);margin-top:6px}
.row{display:flex;gap:8px}
.row .col{flex:1}
.kv{font-size:13px;color:var(--muted)}
.small{font-size:13px;color:var(--muted);margin-top:8px}

/* responsive */
@media (max-width:900px){
  .grid-cols-3{grid-template-columns:1fr}
  .header-row{flex-direction:column;align-items:stretch}
  .controls{align-items:flex-start}
  .nav{flex-wrap:wrap}
}
.countdown{background:rgba(255,255,255,0.12);padding:6px 10px;border-radius:8px;font-weight:700}
.dark-toggle{background:transparent;border:1px solid rgba(255,255,255,0.18);color:white;padding:6px 8px;border-radius:8px;cursor:pointer}
.link-btn{color:var(--accent2);text-decoration:underline;font-weight:600}
</style>
</head>
<body>
<div class="container">
  <header class="header">
    <div class="header-row">
      <div class="brand">
        <div class="logo">📘</div>
        <div>
          <div class="title">جدول المحاضرات</div>
          <div class="subtitle">عرض جدول المحاضرات بتنسيق شبابي وسهل</div>
        </div>
      </div>
      <div class="controls">
        <div id="upcoming" class="info-badge">لا توجد محاضرات قريبة</div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="adminBtn" class="btn">لوحة الإدارة</button>
          <button id="themeToggle" class="dark-toggle">الوضع الداكن</button>
        </div>
      </div>
    </div>
  </header>

  <nav class="nav">
    <button class="active" data-view="home">الرئيسية</button>
    <button data-view="schedule">الجدول</button>
    <button data-view="instructors">الدكاترة</button>
  </nav>

  <main id="mainArea" style="margin-bottom:16px">
    <!-- Home -->
    <section id="view-home" class="card">
      <h2>أهلاً بك</h2>
      <p class="small">هذا الموقع يعرض جدول المحاضرات. الطلبة يمكنهم العرض فقط. لتعديل الجدول ادخل لوحة الإدارة.</p>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px">
        <div class="card">مجموع المحاضرات: <strong id="totalLectures">0</strong></div>
        <div class="card">أيام: <strong>السبت - الخميس</strong></div>
        <div class="card">ساعات: <strong>8:00 ص - 10:00 م</strong></div>
      </div>
    </section>

    <!-- Schedule -->
    <section id="view-schedule" class="card" style="display:none;margin-top:12px">
      <h2>الجدول الأسبوعي</h2>
      <div style="margin-top:8px">الأسابيع: <span class="kv">السبت → الخميس</span></div>
      <div id="scheduleGrid" class="grid grid-cols-3" style="margin-top:12px"></div>
    </section>

    <!-- Instructors -->
    <section id="view-instructors" class="card" style="display:none;margin-top:12px">
      <h2>الدكاترة</h2>
      <div id="instructorList" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px"></div>
    </section>
  </main>

  <footer class="footer">© جدول المحاضرات</footer>
</div>

<!-- Admin FAB -->
<div class="admin-bar">
  <button id="fab" class="fab" title="لوحة الإدارة">✏️</button>
</div>

<!-- Modal templates -->
<div id="modalRoot" style="display:none"></div>

<script>
/* Data & Config */
const ADMIN_PASSWORD = 'khaled181';
const STORAGE_KEY = 'jadwal_site_data_v2';
const DAYS = ['السبت','الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس'];
const HOURS = Array.from({length:15},(_,i)=>8+i); // 8..22

/* Utility */
function uid(){ return 'id'+Math.random().toString(36).slice(2,9); }
function loadData(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {lectures:[], instructors:[]}; }catch(e){ return {lectures:[], instructors:[]}; } }
function saveData(d){ localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }

/* Initial */
let DATA = loadData();
renderAll();

/* View nav */
document.querySelectorAll('.nav button').forEach(b=>{
  b.addEventListener('click', ()=> {
    document.querySelectorAll('.nav button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const view = b.getAttribute('data-view');
    document.querySelectorAll('main > section').forEach(s=> s.style.display='none');
    document.getElementById('view-'+view).style.display='block';
  });
});

/* Theme */
const themeToggle = document.getElementById('themeToggle');
if(localStorage.getItem('jadwal_theme')==='dark') document.documentElement.setAttribute('data-theme','dark');
themeToggle.addEventListener('click', ()=>{
  const current = document.documentElement.getAttribute('data-theme')==='dark';
  document.documentElement.setAttribute('data-theme', current ? '':'dark');
  localStorage.setItem('jadwal_theme', current ? 'light' : 'dark');
});

/* Admin open */
document.getElementById('adminBtn').addEventListener('click', openAdminFlow);
document.getElementById('fab').addEventListener('click', openAdminFlow);

/* Render functions */
function renderAll(){
  renderSchedule();
  renderInstructors();
  document.getElementById('totalLectures').innerText = DATA.lectures.length;
  updateUpcoming();
}

function renderSchedule(){
  const grid = document.getElementById('scheduleGrid');
  grid.innerHTML = '';
  // create columns per day
  DAYS.forEach(day=>{
    const col = document.createElement('div');
    col.className = 'day-column card';
    const h = document.createElement('h3'); h.innerText = day; h.style.marginBottom='8px'; h.style.fontWeight='700';
    col.appendChild(h);
    HOURS.forEach(hr=>{
      const slot = document.createElement('div');
      slot.className = 'slot';
      const lecture = DATA.lectures.find(l=> l.day===day && +l.hour===+hr);
      if(!lecture){ slot.classList.add('empty'); slot.innerHTML = '<div>'+hr+':00 — فارغ</div>'; }
      else{
        const left = document.createElement('div'); left.className='left';
        left.innerHTML = '<div class="title">'+escapeHtml(lecture.title)+'</div><div class="meta">'+(getInstructorName(lecture.instructorId) || '—')+' • '+(lecture.location||'غير محدد')+'</div>' + (lecture.notes?'<div class="meta">ملاحظة: '+escapeHtml(lecture.notes)+'</div>':'');
        const right = document.createElement('div'); right.style.textAlign='right';
        right.innerHTML = '<div>'+hr+':00</div>' + (lecture.link?('<div style="margin-top:6px"><a class="link-btn" target="_blank" href="'+escapeAttr(lecture.link)+'">رابط المحاضرة</a></div>'):'');
        slot.appendChild(left);
        slot.appendChild(right);
      }
      col.appendChild(slot);
    });
    grid.appendChild(col);
  });
}

function renderInstructors(){
  const list = document.getElementById('instructorList');
  list.innerHTML = '';
  if(DATA.instructors.length===0){ list.innerHTML = '<div class="card">لا يوجد دكاترة حتى الآن</div>'; return; }
  DATA.instructors.forEach(i=>{
    const c = document.createElement('div'); c.className='card';
    c.innerHTML = '<div style="font-weight:700">'+escapeHtml(i.name)+'</div><div class="small">'+(i.title||'')+'</div>' + (i.bio?'<p class="small">'+escapeHtml(i.bio)+'</p>':'') + '<div class="small">المواد: '+(i.subjects?escapeHtml(i.subjects.join(', ')):'—')+'</div>';
    list.appendChild(c);
  });
}

/* Upcoming countdown */
let countdownTimer = null;
function updateUpcoming(){
  const up = document.getElementById('upcoming');
  if(DATA.lectures.length===0){ up.innerText='لا توجد محاضرات قريبة'; return; }
  // find next lecture from now (simple: search for nearest by day order starting today)
  const now = new Date();
  // compute day indices mapping for simplicity
  const weekOrder = ['السبت','الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس'];
  // create list of upcoming times
  const candidates = DATA.lectures.map(l=>{
    // find next date for this day (this week)
    const todayIndex = ((now.getDay()+1)%7); // approximate mapping
    const targetIndex = weekOrder.indexOf(l.day);
    let deltaDays = (targetIndex - todayIndex);
    if(deltaDays<0) deltaDays += 7;
    const d = new Date(now.getFullYear(), now.getMonth(), now.getDate()+deltaDays, +l.hour, 0, 0);
    return {lecture:l, date:d};
  });
  // filter future, sort by date
  const future = candidates.filter(c=> c.date >= now).sort((a,b)=> a.date - b.date);
  const next = future.length ? future[0] : candidates.sort((a,b)=> a.date - b.date)[0];
  if(!next){ up.innerText='لا توجد محاضرات قريبة'; return; }
  // start countdown
  if(countdownTimer) clearInterval(countdownTimer);
  function tick(){
    const diff = next.date - new Date();
    if(diff<=0){ up.innerText = 'المحاضرة الآن: ' + next.lecture.title; renderAll(); return; }
    const hrs = Math.floor(diff/3600000);
    const mins = Math.floor((diff%3600000)/60000);
    const secs = Math.floor((diff%60000)/1000);
    up.innerHTML = '<span class="countdown">المحاضرة القادمة: '+escapeHtml(next.lecture.title)+' بعد '+hrs+' ساعة '+mins+' دقيقة</span>';
  }
  tick();
  countdownTimer = setInterval(tick,1000);
}

/* Admin flow */
function openAdminFlow(){
  openPasswordModal();
}

function openPasswordModal(){
  const modalRoot = document.getElementById('modalRoot');
  modalRoot.innerHTML = '';
  const wrap = document.createElement('div'); wrap.className='modal-back';
  const m = document.createElement('div'); m.className='modal';
  m.innerHTML = '<h3>دخول لوحة الإدارة</h3><p class="small">أدخل كلمة المرور لإدارة الموقع</p><input id="pw" class="input" type="password" placeholder="كلمة المرور" /><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px"><button id="closePw" class="btn">إلغاء</button><button id="submitPw" class="btn">دخول</button></div>';
  wrap.appendChild(m); modalRoot.appendChild(wrap); modalRoot.style.display='block';
  document.getElementById('closePw').onclick = ()=>{ modalRoot.style.display='none'; modalRoot.innerHTML=''; };
  document.getElementById('submitPw').onclick = ()=>{ const v = document.getElementById('pw').value; if(v===ADMIN_PASSWORD){ modalRoot.style.display='none'; modalRoot.innerHTML=''; openAdminPanel(); } else alert('كلمة المرور خاطئة'); };
}

function openAdminPanel(){
  const modalRoot = document.getElementById('modalRoot');
  modalRoot.innerHTML = '';
  const wrap = document.createElement('div'); wrap.className='modal-back';
  const m = document.createElement('div'); m.className='modal';
  m.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center"><h3>لوحة الإدارة</h3><div><button id="saveBtn" class="btn">حفظ</button> <button id="closeAdmin" class="btn">خروج</button></div></div><div style="margin-top:12px"><div style="display:flex;gap:8px;"><button id="tabLec" class="btn">المحاضرات</button><button id="tabInst" class="btn">الدكاترة</button></div><div id="adminBody" style="margin-top:12px"></div></div>';
  wrap.appendChild(m); modalRoot.appendChild(wrap); modalRoot.style.display='block';
  document.getElementById('closeAdmin').onclick = ()=>{ modalRoot.style.display='none'; modalRoot.innerHTML=''; };
  document.getElementById('saveBtn').onclick = ()=>{ saveData(DATA); alert('تم الحفظ'); renderAll(); };
  document.getElementById('tabLec').onclick = ()=> renderAdminLectures();
  document.getElementById('tabInst').onclick = ()=> renderAdminInstructors();
  renderAdminLectures();
}

function renderAdminLectures(){
  const body = document.getElementById('adminBody');
  body.innerHTML = '';
  const form = document.createElement('form');
  form.innerHTML = '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px"><div><label class="kv">اليوم</label><select id="fDay" class="input">'+DAYS.map(d=>'<option value="'+d+'">'+d+'</option>').join('')+'</select></div><div><label class="kv">الساعة</label><select id="fHour" class="input">'+HOURS.map(h=>'<option value="'+h+'">'+h+':00</option>').join('')+'</select></div></div><input id="fTitle" class="input" placeholder="اسم المادة" required /><select id="fInst" class="input"><option value="">اختر دكتور (اختياري)</option>'+DATA.instructors.map(i=>'<option value="'+i.id+'">'+i.name+'</option>').join('')+'</select><input id="fLocation" class="input" placeholder="المكان (قاعة)" /><input id="fLink" class="input" placeholder="رابط المحاضرة (لينك)" /><textarea id="fNotes" class="input" placeholder="ملاحظات"></textarea><div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn" type="submit">أضف المحاضرة</button></div>';
  body.appendChild(form);
  form.onsubmit = (e)=>{ e.preventDefault(); const lec = { id: uid(), day: document.getElementById('fDay').value, hour: +document.getElementById('fHour').value, title: document.getElementById('fTitle').value, instructorId: document.getElementById('fInst').value || null, location: document.getElementById('fLocation').value, link: document.getElementById('fLink').value, notes: document.getElementById('fNotes').value }; DATA.lectures.push(lec); renderAdminLectures(); renderAll(); };
  // list existing
  const list = document.createElement('div'); list.style.marginTop='12px';
  if(DATA.lectures.length===0) list.innerHTML = '<div class="card">لا توجد محاضرات بعد</div>';
  else{
    const ul = document.createElement('ul'); ul.style.listStyle='none'; ul.style.padding=0; ul.style.display='grid'; ul.style.gap='8px';
    DATA.lectures.forEach(l=>{
      const li = document.createElement('li'); li.className='card';
      li.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:700">'+escapeHtml(l.title)+'</div><div class="small">'+l.day+' '+l.hour+':00 • '+(getInstructorName(l.instructorId)||'—')+'</div></div><div><button class="btn" data-id="'+l.id+'">حذف</button></div></div>';
      ul.appendChild(li);
    });
    list.appendChild(ul);
    list.querySelectorAll('button').forEach(b=> b.addEventListener('click', ()=>{ const id=b.getAttribute('data-id'); if(confirm('حذف المحاضرة؟')){ DATA.lectures = DATA.lectures.filter(x=>x.id!==id); renderAdminLectures(); renderAll(); } }));
  }
  body.appendChild(list);
}

function renderAdminInstructors(){
  const body = document.getElementById('adminBody');
  body.innerHTML = '';
  const form = document.createElement('form');
  form.innerHTML = '<input id="iName" class="input" placeholder="اسم الدكتور" required /><input id="iTitle" class="input" placeholder="التخصص/المسمى" /><input id="iSubjects" class="input" placeholder="المواد (افصل بفاصلة)" /><textarea id="iBio" class="input" placeholder="نبذة عن الدكتور"></textarea><div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn" type="submit">أضف الدكتور</button></div>';
  body.appendChild(form);
  form.onsubmit = (e)=>{ e.preventDefault(); const inst = { id: uid(), name: document.getElementById('iName').value, title: document.getElementById('iTitle').value, subjects: document.getElementById('iSubjects').value.split(',').map(s=>s.trim()).filter(Boolean), bio: document.getElementById('iBio').value }; DATA.instructors.push(inst); renderAdminInstructors(); renderAll(); };
  const list = document.createElement('div'); list.style.marginTop='12px';
  if(DATA.instructors.length===0) list.innerHTML = '<div class="card">لا يوجد دكاترة بعد</div>';
  else{
    const ul = document.createElement('ul'); ul.style.listStyle='none'; ul.style.padding=0; ul.style.display='grid'; ul.style.gap='8px';
    DATA.instructors.forEach(i=>{
      const li = document.createElement('li'); li.className='card';
      li.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:700">'+escapeHtml(i.name)+'</div><div class="small">'+escapeHtml(i.title||'')+'</div></div><div><button class="btn" data-id="'+i.id+'">حذف</button></div></div>';
      ul.appendChild(li);
    });
    list.appendChild(ul);
    list.querySelectorAll('button').forEach(b=> b.addEventListener('click', ()=>{ const id=b.getAttribute('data-id'); if(confirm('حذف الدكتور؟')){ DATA.instructors = DATA.instructors.filter(x=>x.id!==id); renderAdminInstructors(); renderAll(); } }));
  }
  body.appendChild(list);
}

/* Helpers */
function getInstructorName(id){ if(!id) return null; const i = DATA.instructors.find(x=>x.id===id); return i?i.name:null; }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escapeAttr(s){ if(!s) return ''; return String(s).replace(/"/g,'&quot;'); }

/* simple storage autosave on unload */
window.addEventListener('beforeunload', ()=> saveData(DATA));

/* initial theme set if not set */
if(!localStorage.getItem('jadwal_theme')) localStorage.setItem('jadwal_theme','light');

/* expose simple export/import (for advanced use) */
window.jadwal = {
  export: ()=> JSON.stringify(DATA),
  import: (json)=> { try{ DATA = JSON.parse(json); saveData(DATA); renderAll(); alert('تم الاستيراد'); }catch(e){ alert('خطأ بالملف') } }
};

</script>
</body>
</html>
