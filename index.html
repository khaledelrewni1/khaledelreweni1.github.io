<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>📘 جدول المحاضرات</title>
<link rel="icon" href="icons/favicon.png">
<style>
:root{
  --accent1:#60a5fa; --accent2:#7c3aed;
  --bg-grad: linear-gradient(90deg,var(--accent1),var(--accent2));
  --card:#ffffff; --text:#071127; --muted:#475569;
  --cell-border: rgba(2,6,23,0.06);
}
[data-theme="dark"]{
  --card:#071127; --text:#e6eef8; --muted:#9ca3af; --cell-border: rgba(255,255,255,0.06);
  --bg-grad: linear-gradient(90deg,#0f172a,#0b1220);
}
*{box-sizing:border-box}
body{margin:0;font-family:'Cairo',sans-serif;background:var(--bg-grad);color:var(--text);min-height:100vh}
.container{max-width:1200px;margin:0 auto;padding:18px}
.header-row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px;color:white}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:52px;height:52px;border-radius:10px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;font-size:28px}
.title{font-size:20px;font-weight:800}
.controls{display:flex;gap:8px;align-items:center}
.btn{background:white;color:#3730a3;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
.small-btn{background:transparent;border:1px solid rgba(255,255,255,0.18);color:white;padding:6px 10px;border-radius:8px;cursor:pointer}
.info-badge{background:rgba(255,255,255,0.16);padding:6px 10px;border-radius:8px;font-size:13px}
.nav{display:flex;gap:8px;margin:12px 0}
.tab-btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;background:rgba(255,255,255,0.12);color:white;font-weight:700}
.tab-btn.active{background:white;color:#3730a3}
.card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 8px 30px rgba(2,6,23,0.12);color:var(--text)}
.table-wrap{overflow:auto}
.table{width:100%;border-collapse:collapse;background:var(--card);border-radius:8px;overflow:hidden}
.table th, .table td{border:1px solid var(--cell-border);padding:10px;text-align:center;font-size:14px}
.table th{background:rgba(0,0,0,0.03);font-weight:800}
.slot{padding:6px;border-radius:6px}
.slot .meta{font-size:12px;color:var(--muted);margin-top:6px}
.empty{opacity:0.45}
.current{outline:3px solid rgba(124,58,237,0.18);box-shadow:0 6px 18px rgba(124,58,237,0.08)}
.legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.legend-item{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.06);font-size:13px}
.footer{padding:12px;text-align:center;color:rgba(255,255,255,0.9);opacity:0.9;margin-top:12px}
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;padding:16px;z-index:9999}
.modal{width:100%;max-width:900px;background:var(--card);border-radius:12px;padding:16px;color:var(--text);max-height:90vh;overflow:auto}
.input, textarea, select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(2,6,23,0.06);margin-top:6px}
.row{display:flex;gap:8px}
.col{flex:1}
.kv{font-size:13px;color:var(--muted)}
.top-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between}
.days-tabs{display:flex;gap:6px;flex-wrap:wrap}
.day-tab{padding:6px 10px;border-radius:8px;border:none;cursor:pointer;background:rgba(15,23,42,0.03)}
.day-tab.active{background:var(--accent2);color:white}
@media (max-width:900px){
  .header-row{flex-direction:column;align-items:flex-start}
  .row{flex-direction:column}
  .table th, .table td{font-size:12px;padding:8px}
}
.notice-small{font-size:13px;color:rgba(255,255,255,0.9);opacity:0.95;margin-top:6px}
</style>
</head>
<body>
<div class="container">
  <div class="header-row">
    <div class="brand">
      <div class="logo">📘</div>
      <div>
        <div class="title">📘 جدول المحاضرات</div>
        <div class="notice-small">يتم تحديث الجدول يومياً</div>
      </div>
    </div>
    <div class="controls">
      <div id="liveNotice" class="info-badge">لا توجد محاضرات الآن</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="exportBtn" class="small-btn" title="تصدير JSON">تصدير</button>
        <button id="importBtn" class="small-btn" title="استيراد JSON">استيراد</button>
        <button id="printBtn" class="small-btn" title="تحميل PDF">تحميل PDF</button>
        <button id="adminBtn" class="btn" title="لوحة الإدارة">لوحة الإدارة</button>
        <button id="themeToggle" class="small-btn" title="تبديل الوضع">الوضع</button>
      </div>
    </div>
  </div>

  <nav class="nav">
    <button class="tab-btn active" data-tab="weekly">الجدول الأسبوعي</button>
    <button class="tab-btn" data-tab="day">اليوم</button>
    <button class="tab-btn" data-tab="instructors">الدكاترة</button>
  </nav>

  <main>
    <!-- Weekly Tab -->
    <section id="tab-weekly" class="card table-wrap">
      <h3>الجدول الأسبوعي</h3>
      <div class="top-actions" style="margin-bottom:8px">
        <div class="kv">ساعات: 8:00 ص → 10:00 م</div>
        <div id="legend" class="legend"></div>
      </div>
      <div id="tableContainer"></div>
    </section>

    <!-- Day Tab -->
    <section id="tab-day" class="card" style="display:none;margin-top:12px">
      <h3>محاضرات حسب اليوم</h3>
      <div class="days-tabs" id="daysTabs"></div>
      <div id="dayContainer" style="margin-top:12px"></div>
    </section>

    <!-- Instructors Tab -->
    <section id="tab-instructors" class="card" style="display:none;margin-top:12px">
      <h3>الدكاترة</h3>
      <div id="instructorList" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px"></div>
    </section>

    <section class="card" style="margin-top:12px">
      <h4>تصميم وبرمجة: Khaled El-Reweni 💻</h4>
    </section>
  </main>

  <footer class="footer">© جدول المحاضرات</footer>
</div>

<div id="modalRoot" style="display:none"></div>

<script>
/* Config */
const ADMIN_PASSWORD = 'khaled181';
const STORAGE_KEY = 'jadwal_v3_data';
const DAYS = ['السبت','الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس','الجمعة'];
const HOURS = Array.from({length:15},(_,i)=>8+i);

/* Time helpers */
function formatHeader(h) {
  let start = h % 12;
  if (start === 0) start = 12;
  let end = (h + 1) % 12;
  if (end === 0) end = 12;
  const startPeriod = h < 12 ? 'ص' : 'م';
  const endPeriod = (h + 1) <= 12 ? 'ص' : 'م';
  if (startPeriod === endPeriod) {
    return `${start} - ${end} ${startPeriod}`;
  } else {
    return `${start} ${startPeriod} - ${end} ${endPeriod}`;
  }
}
function to12WithMin(h,m){ const hour = parseInt(h,10); const period = hour>=12 ? 'م' : 'ص'; let hh = hour%12; if(hh===0) hh=12; return hh + ':' + String(m).padStart(2,'0') + ' ' + period; }

/* Data storage */
function uid(){ return 'id'+Math.random().toString(36).slice(2,9); }
function loadData(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {lectures:[], instructors:[]}; }catch(e){ return {lectures:[], instructors:[]}; } }
function saveData(d){ localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }

let DATA = loadData();
let editingId = null;

/* Helpers */
function getInstructorName(id){ if(!id) return null; const i = DATA.instructors.find(x=>x.id===id); return i?i.name:null; }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escapeAttr(s){ if(!s) return ''; return String(s).replace(/"/g,'&quot;'); }

/* Color per subject */
const colorCache={};
function genColor(title){ if(!title) return {bg:'rgba(243,244,246,0.6)',solid:'#e5e7eb'}; if(colorCache[title]) return colorCache[title]; let h=0; for(let i=0;i<title.length;i++){ h=(h<<5)-h+title.charCodeAt(i); h|=0; } const r=Math.abs(h)%200+20; const g=(Math.abs(h*13)%150)+80; const b=(Math.abs(h*7)%180)+40; const bg='rgba('+r+','+g+','+b+',0.18)'; const solid='rgba('+r+','+g+','+b+',0.95)'; colorCache[title]={bg,solid}; return colorCache[title]; }

/* Render weekly table */
function renderTable(){
  const container=document.getElementById('tableContainer'); container.innerHTML='';
  const table=document.createElement('table'); table.className='table';
  const thead=document.createElement('thead'); const headRow=document.createElement('tr'); headRow.appendChild(document.createElement('th'));
  HOURS.forEach(h=>{ const th=document.createElement('th'); th.innerText=formatHeader(h); headRow.appendChild(th); });
  thead.appendChild(headRow); table.appendChild(thead);
  const tbody=document.createElement('tbody'); const map={};
  DATA.lectures.forEach(l=>{ if(!l.day) return; if(!map[l.day]) map[l.day]=[]; map[l.day].push(l); });
  DAYS.forEach(day=>{ 
    const tr=document.createElement('tr'); 
    const dayCell=document.createElement('th'); 
    dayCell.innerText=day; 
    tr.appendChild(dayCell);
    const dayLectures = (map[day] || []).sort((a,b) => (a.startHour + (a.startMin || 0)/60) - (b.startHour + (b.startMin || 0)/60));
    let hourToLecs = {};
    HOURS.forEach(hh => {
      hourToLecs[hh] = dayLectures.filter(l => {
        const s = l.startHour + (l.startMin || 0)/60;
        const e = l.endHour + (l.endMin || 0)/60;
        return s <= hh && hh < e;
      });
    });
    let hourIdx = 0;
    while (hourIdx < HOURS.length) {
      const h = HOURS[hourIdx];
      const currentLecs = hourToLecs[h];
      if (currentLecs.length === 0) {
        const td = document.createElement('td');
        td.innerHTML = '<div class="slot empty">فارغ</div>';
        tr.appendChild(td);
        hourIdx++;
        continue;
      }
      // Calculate span where the set of lectures is the same
      let span = 1;
      const lecIds = currentLecs.map(l => l.id).sort();
      const key = JSON.stringify(lecIds);
      while (hourIdx + span < HOURS.length) {
        const nextH = HOURS[hourIdx + span];
        const nextLecs = hourToLecs[nextH];
        const nextIds = nextLecs.map(l => l.id).sort();
        const nextKey = JSON.stringify(nextIds);
        if (nextKey === key) {
          span++;
        } else {
          break;
        }
      }
      const td = document.createElement('td');
      td.colSpan = span;
      const box = document.createElement('div');
      currentLecs.forEach(lec => {
        const col = genColor(lec.title);
        const div = document.createElement('div');
        div.className = 'slot';
        div.style.background = col.bg;
        div.style.borderRadius = '8px';
        div.style.padding = '6px';
        div.style.marginBottom = '6px';
        const title = document.createElement('div');
        title.style.fontWeight = '800';
        title.style.color = col.solid;
        title.innerText = lec.title;
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.innerText = (getInstructorName(lec.instructorId) || lec.instructorName || '') + ' • ' + (lec.location || (lec.link ? 'أونلاين' : 'غير محدد'));
        const timeEl = document.createElement('div');
        timeEl.className = 'meta';
        timeEl.innerText = to12WithMin(lec.startHour, lec.startMin || 0) + ' — ' + to12WithMin(lec.endHour, lec.endMin || 0);
        div.appendChild(title);
        div.appendChild(meta);
        div.appendChild(timeEl);
        if (lec.link) {
          const a = document.createElement('a');
          a.href = lec.link;
          a.target = '_blank';
          a.innerText = 'رابط المحاضرة';
          a.style.display = 'block';
          a.style.marginTop = '6px';
          div.appendChild(a);
        }
        if (isNowInLecture(lec)) div.classList.add('current');
        box.appendChild(div);
      });
      td.appendChild(box);
      tr.appendChild(td);
      hourIdx += span;
    }
    tbody.appendChild(tr);
  });
  table.appendChild(tbody); container.appendChild(table); renderLegend();
}

/* Render day tabs and day view */
function renderDaysTabs(){
  const daysTabs=document.getElementById('daysTabs'); daysTabs.innerHTML='';
  DAYS.forEach(d=>{ const btn=document.createElement('button'); btn.className='day-tab'; btn.innerText=d; btn.onclick=()=> showDay(d); daysTabs.appendChild(btn); });
  // activate today by default
  const jsWeek=['الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت']; const today=jsWeek[new Date().getDay()];
  showDay(today);
}
function showDay(day){
  // highlight selected tab
  document.querySelectorAll('.day-tab').forEach(b=> b.classList.toggle('active', b.innerText===day));
  const container=document.getElementById('dayContainer'); container.innerHTML='';
  const lectures=(DATA.lectures||[]).filter(l=> l.day===day).sort((a,b)=> (a.startHour+a.startMin/60)-(b.startHour+b.startMin/60));
  if(lectures.length===0){ container.innerHTML='<div class="card">لا توجد محاضرات لهذا اليوم</div>'; return; }
  lectures.forEach(lec=>{
    const card=document.createElement('div'); card.className='card'; card.style.marginBottom='8px';
    const title=document.createElement('div'); title.style.fontWeight='800'; title.innerText=lec.title;
    const meta=document.createElement('div'); meta.className='kv'; meta.innerText=(getInstructorName(lec.instructorId)||lec.instructorName||'') + ' • ' + (lec.location|| (lec.link? 'أونلاين':'غير محدد'));
    const timeEl=document.createElement('div'); timeEl.className='kv'; timeEl.innerText = to12WithMin(lec.startHour,lec.startMin||0) + ' — ' + to12WithMin(lec.endHour,lec.endMin||0);
    card.appendChild(title); card.appendChild(meta); card.appendChild(timeEl); if(lec.link){ const a=document.createElement('a'); a.href=lec.link; a.target='_blank'; a.innerText='رابط المحاضرة'; a.style.display='block'; a.style.marginTop='6px'; card.appendChild(a); }
    if(isNowInLecture(lec)) card.classList.add('current');
    container.appendChild(card);
  });
}

/* Render instructors */
function renderInstructors(){ const list=document.getElementById('instructorList'); list.innerHTML=''; if(DATA.instructors.length===0){ list.innerHTML='<div class="card">لا يوجد دكاترة حتى الآن</div>'; return; }
